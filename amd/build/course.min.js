define ("format_tiles/course",["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","format_tiles/tile_fitter"],function(a,b,c,d,e,f,g){"use strict";var h=a("body"),i=a("body, html"),j,k,l=[],m,n=!1,o=!1,p=60,q=!1,r=0,s,t=!1,u,v=0,w={PAGE:"#page",TILE:".tile",TILEID:"#tile-",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_LOADING_ICON_ID:"#loading-icon-",TILE_COLLAPSED:".tile-collapsed",TILE_CLICKABLE:".tile-clickable",TILES:"ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:".sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",MOODLE_VIDEO:".mediaplugin.mediaplugin_videojs",LAUNCH_STANDARD:"[data-action=\"launch-tiles-standard\"]",TOOLTIP:"[data-toggle=tooltip]",HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.moodle-has-zindex","#navwrap","nav.navbar-fixed-top","#adaptable-page-header-wrapper"]},x={SELECTED:"selected",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal",STATE_VISIBLE:"state-visible"},y={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},z={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"},A={ESCAPE:27,TAB:9,RETURN:13},B=function(b){var c=a(w.SECTION_ID+b);c.find("iframe").each(function(b,c){c=a(c);if(c.attr("src")){c.attr("data-src",c.attr("src"));c.attr("src","")}});var d=c.find(w.MOODLE_VIDEO);if(0<d.length){c.html("")}},C=function(b){a(w.MOVEABLE_SECTION).each(function(b,c){c=a(c);if(c.is(":visible")){B(c.attr("data-section"));c.slideUp().removeClass(x.STATE_VISIBLE)}});a(w.TILE).removeClass(x.SELECTED).css(z.Z_INDEX,"").css(z.BG_COLOUR,"");a(".section "+x.SELECTED).removeClass(x.SELECTED).css(z.Z_INDEX,"");m.fadeOut(300);if(b!==void 0&&0!==b){a(w.TILEID+b).focus()}a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html("")});o=!1;v=0},D=function(b,c){if(c){b.html(c);a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html("")});if(b.attr("id")!==w.SECTION_ZERO){var e=b.find(w.ACTIVITY).not(w.SPACER);b.on(y.KEYDOWN,function(c){if(c.keyCode===A.ESCAPE){d.setLastVisitedSection(0);C(0);a(w.TILEID+b.attr("data-section")).focus()}});e.on(y.KEYDOWN,function(b){if(b.keyCode===A.RETURN){var c=a(b.currentTarget).find("a");if(c.hasClass(x.LAUNCH_CM_MODAL)){c.click()}else if(c.attr("href")!==void 0){window.location=c.attr("href")}}});if(!j){e.last().on(y.KEYDOWN,function(c){if(c.keyCode===A.TAB&&!c.shiftKey&&a(c.relatedTarget).closest(w.SECTION_MAIN).attr("id")!==b.attr("id")){setTimeout(function(){b.find(w.SECTION_TITLE).focus();i.animate({scrollTop:b.offset().top-p},"slow");b.find(w.SECTION_BUTTONS).css("top","")},200)}});b.find(w.SECTION_TITLE).on(y.KEYDOWN,function(c){if(c.keyCode===A.TAB&&c.shiftKey&&a(c.relatedTarget).closest(w.SECTION_MAIN).attr("id")!==b.attr("id")){setTimeout(function(){e.last().focus()},200)}})}}if(!j){setTimeout(function(){try{var a=b.find(".badge-info");if(0<a.length&&"function"==typeof a.tooltip){a.tooltip()}}catch(a){require(["core/log"],function(b){b.debug(a)})}},500)}if(0!==b.find(w.MOODLE_VIDEO).length){require(["media_videojs/loader"],function(a){a.setUp()})}return!0}return!1},E=function(b,c){var d=function(){var d=a("#tileText-"+c).offset().top-p;if(d===a(window).scrollTop){d+=1}b.find(w.SECTION_TITLE).focus();h.on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove",function(){h.stop()});i.animate({scrollTop:d},"slow",function(){i.off("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove",function(){i.stop()})});o=!0;v=c;b.find(w.ACTIVITY).first().focus();var e=b.find("iframe");if(0<e.length){e.each(function(b,c){c=a(c);if(""===c.attr("src")&&c.attr("data-src")!==void 0){c.attr("src",c.attr("data-src"))}});if(u){require(["format_tiles/completion"],function(a){setTimeout(function(){a.updateTileInformation()},1e3)})}}},e=function(){var c=b.find(w.SECTION_BUTTONS);a(window).on(y.SCROLL,function(){if(!n&&o){n=!0;c.fadeOut(300);setTimeout(function(){var d=a(window).scrollTop(),e=d-b.offset().top+50;if(0<e&&e<b.outerHeight()-100){e=d-b.offset().top+50;c.css("top",e);if("none"===m.css(z.DISPLAY)){m.fadeIn(300)}}else if(0>e){c.css("top",0)}if(d>b.offset().top+b.outerHeight()-50){if("block"===m.css(z.DISPLAY)){m.fadeOut(300)}c.css("top",0)}else if(b.offset().top>d+a(window).outerHeight()){if("block"===m.css(z.DISPLAY)){m.fadeOut(300)}c.css("top",0)}else if("none"===m.css(z.DISPLAY)){m.fadeIn(300)}c.fadeIn(300,function(){n=!1})},500)}});if(!n&&!o&&m.is(":visible")){m.fadeOut(300)}};b.addClass(x.STATE_VISIBLE);b.slideDown(350,function(){d();e()});v=c},F=function(b,c){var d=new a.Deferred,e=a(".moveablesection:visible"),f=0;if(0<e.length){f=e.attr("data-section");C()}var h=function(a){g.runReOrg(a).done(function(a){if(0!==f){E(e,f)}d.resolve(a)}).fail(function(a){if(0!==f){E(e,f)}d.reject(a)})};if(c){setTimeout(function(){g.resizeTilesDivWidth(s).done(function(){h(!1)},b)})}else{h(b)}return d.promise()},G=function(a,b,c){if(b){e.confirm(l.sectionerrortitle,l.sectionerrorstring,l.refresh,l.cancel,function(){window.location.reload()},null);c.html("")}else{D(c,"<p>"+l.noconnectionerror+"</p>");setTimeout(function(){E(c,a)},500)}require(["core/log"],function(a){a.debug(b)});throw new Error("Not successful retrieving tile content by AJAX for section "+a)},H=function(a,b){return c.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:a,sectionid:b,setjsusedsession:!0}}])[0]},I=function(a,c,d,e){var f=0>e?0:255,h=0>e?-1*e:e,i=Math.round((f-a)*h)+a,j=Math.round((f-c)*h)+c,g=Math.round((f-d)*h)+d;return"rgb("+i+","+j+","+g+")"},J=function(b){m.fadeIn(300);r=parseInt(m.css(z.Z_INDEX));var c=a(w.TILEID+b);c.css(z.Z_INDEX,r+1);a(w.SECTION_ID+b).css(z.Z_INDEX,r+1);if(c.css(z.BG_COLOUR)&&"rgba"===c.css(z.BG_COLOUR).substr(0,4)){var d=c.css(z.BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");c.css(z.BG_COLOUR,I(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]),.95))}},K=function(b){var c=a(b.currentTarget);if("window-overlay"===c.attr("id")){c.hide();var d=a(document.elementFromPoint(b.clientX,b.clientY));c.show();if("window-overlay"===c.attr("id")){if(d.hasClass("filterbutton")||d.hasClass("list-group-item")){d.click()}else{var e=d.closest(w.TILE);if(e){e.click()}}}else{C(0);d.click()}}},L=function(){var b=a(w.HIDE_SEC0_BTN),c=a(w.SECTION_ZERO);if(d.storageEnabledLocal()){if(!0===d.getSecZeroCollapseStatus()){c.slideUp(0);b.addClass(x.CLOSED).removeClass(x.OPEN)}else{c.slideDown(300);b.addClass(x.OPEN).removeClass(x.CLOSED)}}else{b.addClass(x.OPEN).removeClass(x.CLOSED);c.slideDown(300)}},M=function(b,f,g,h){J(g);a(w.TILE).removeClass(x.SELECTED);f.addClass(x.SELECTED);v=g;a(w.MOVEABLE_SECTION).each(function(b,c){c=a(c);if(c.is(":visible")){B(c.attr("data-section"));c.slideUp(200).removeClass(x.STATE_VISIBLE)}});c.call([{methodname:"format_tiles_log_tile_click",args:{courseid:b,sectionid:g}}])[0].fail(e.exception);var i=a(w.SECTION_ID+g);if(0<i.find(w.ACTIVITY).length){E(i,g);if(d.getStoredContentAge(b,g)>h||!d.getStoredContentAge(b,g)){H(b,g).done(function(c){if(d.storageEnabledSession()){d.storeCourseContent(b,g,a(c.html).html())}})}}else{i.html(k);if(d.storageEnabledLocal()){var j=d.getStoredContentAge(b,g);if(j){D(i,d.getCourseContent(b,g));E(i,g)}if(!j||j>h){var l=a(w.TILE_LOADING_ICON_ID+g);if(l!==void 0){l.html(k).fadeIn(200)}else{l=a("<div>").html(k);i.html(l)}H(b,g).done(function(c){var e=a(c.html).html();D(i,e);E(i,g);if(d.storageEnabledSession()){d.storeCourseContent(b,g,e)}}).fail(function(a){G(g,a,i);C(g)})}}else{H(b,g).done(function(b){D(i,a(b.html).html());E(i,g)}).fail(function(a){G(g,a,i);C(g)})}}d.setLastVisitedSection(g)};return{init:function init(e,i,n,o,p,B,E,G,I,J,N,O,P,Q){s=e;j=o;q="1"===J;G=1===G;I="1"===I;u="1"===Q;d.init(s,n,!1,p,E,I,N);a(document).ready(function(){var e=a("#page-content");if(0===e.length){e=a("#region-main")}if(0!==p){v=p}else{if(q&&d.storageEnabledLocal){v=d.getLastVisitedSection()}}if(0!==v){g.init(s,v,O,!1)}else{a(w.TILEID+"1").focus();g.init(s,null,O,!1)}var n=a(window).outerWidth();if(i){m=a("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(h);m.click(function(a){C(0);K(a)});e.on(y.CLICK,w.TILE_CLICKABLE,function(b){if(!i){return}b.preventDefault();a(window).off(y.SCROLL);a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html()});var c=a(b.currentTarget).closest(w.TILE),e=parseInt(c.attr("data-section"));if(c.hasClass(x.SELECTED)){C(e);d.setLastVisitedSection(0)}else{M(s,c,e,B)}var f=a(w.SECTION_ID+(e+1));if(!j&&!P&&f.length&&0<e){setTimeout(function(){var b=d.getStoredContentAge(s,e+1);if(b){D(f,d.getCourseContent(s,e+1))}if(!b||b>B){H(s,e+1).done(function(b){D(f,a(b.html).html());if(d.storageEnabledSession()){d.storeCourseContent(s,e+1,a(b.html).html())}})}},2e3)}});a(window).on("resize",function(){if(t||n===a(window).outerWidth()){return}t=!0;setTimeout(function(){var b=!0,c=a(".moveablesection:visible");if(0!==c.length){var d=c.find(".mediaplugin iframe");if(0!==d.length){d.each(function(d,e){e=a(e);if(e.outerWidth()>c.outerWidth()){b=!1}})}}if(b){n=a(window).outerWidth();F(!0,O)}t=!1},600)});var o=parseInt(m.css(z.Z_INDEX)),u=a(w.HEADER_BAR.find(function(b){return 0<a(b).length}));if(u!==void 0&&0!==u.length){u.css(z.Z_INDEX,o+3)}e.on(y.CLICK,w.CLOSE_SEC_BTN,function(b){C(a(b.currentTarget).attr("data-section"))});e.on(y.CLICK,w.LAUNCH_STANDARD,function(b){var c=a(b.currentTarget);if(c.attr("href")!==void 0){window.location=c.attr("href")}else if(c.find("a").attr("href")!==void 0){window.location=c.find("a").attr("href")}});L()}a(document).on("format-tiles-completion-changed",function(b,d){var e=a(w.TILE).not(w.SPACER).map(function(b,c){return parseInt(a(c).attr("data-section"))}).toArray();e.push(0);var f=c.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:s,sectionid:d.section,setjsusedsession:!0}},{methodname:"format_tiles_get_section_information",args:{courseid:s,sectionnums:e}}]);f[0].done(function(b){D(a(w.SECTION_ID+d.section),a(b.html).html())}).catch(function(a){require(["core/log"],function(b){b.debug(a)})});f[1].done(function(a){require(["format_tiles/completion"],function(b){b.updateSectionsInfo(a.sections,a.overall.complete,a.overall.outof)})}).catch(function(a){require(["core/log"],function(b){b.debug(a)})})});e.on(y.CLICK,w.HIDE_SEC0_BTN,function(b){var c=a(w.SECTION_ZERO);if("none"===c.css(z.DISPLAY)){c.slideDown(250);a(b.currentTarget).addClass(x.OPEN).removeClass(x.CLOSED);d.setSecZeroCollapseStatus("collapsed")}else{c.slideUp(250);a(b.currentTarget).addClass(x.CLOSED).removeClass(x.OPEN);d.setSecZeroCollapseStatus("expanded")}});if(G){require(["format_tiles/filter_buttons"],function(a){a.init(s,d.storageEnabledLocal)});if(i){e.on(y.CLICK,w.FILTER_BUTTON,function(){C(0);F(!0,!1)})}}a(".tiles_coursenav").removeClass("hidden");b.render("format_tiles/loading",{}).done(function(a){k=a});var E=[{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"},{key:"blockedpopuptitle",component:"format_tiles"}];f.get_strings(E).done(function(a){a.forEach(function(b,c){if(b){l[E[c].key]=b}else{l[E[c].key]="Error.";require(["core/log"],function(b){b.debug("Format tiles get_strings error ".concat(c));b.debug(a)})}})}).fail(function(a){require(["core/log"],function(b){b.debug(a)})});if(j){e.on(y.CLICK,w.ACTIVITY+".video a",function(b){var d=a(b.currentTarget),e=d.closest(w.ACTIVITY).attr("data-url-secondary");if(e!==void 0){b.preventDefault();b.stopPropagation();var f=d.closest(w.ACTIVITY);c.call([{methodname:"format_tiles_log_mod_view",args:{courseid:s,cmid:f.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(a){a.markAsAutoCompleteInUI(s,f)})});window.location=e}})}else{a(w.TILE).on(y.KEYDOWN,function(b){if(b.keyCode===A.RETURN){a(b.currentTarget).click()}});a("ul.tiles .tile").first().focus()}a(document).on("filter-content-updated",function(b,c){if(0<c.length){var d=a(c[0]);if(d.hasClass("moodle-dialogue")&&d.css("z-index")<r){d.css("z-index",r+1)}}})})}}});
//# sourceMappingURL=course.min.js.map
